---
title: "Advanced R: Shiny"
author: "Justin Post"
date: "August 15-16, 2019"
output:       
      ioslides_presentation:
         css: css/style.css
         widescreen: yes
transition: faster
logo: img/logo.PNG
runtime: shiny
---


```{r setup,echo=FALSE,message=FALSE, warning = FALSE}
library(dplyr)
options(dplyr.print_min = 5)
library(knitr)
library(readr)
opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

## What do we want to be able to do?

- Communicate findings effectively 

- Document findings 

- Make process reproducible  

- Share process



## Where do we start?  

- Review of Key Concepts  

- R Markdown Basics  
    + Code Chunks
    + Images/Equations/Misc.

- R Markdown Options
    + Documents: PDF, HTML 
    + Presentations: Slides
    + Interactive Components

- R Shiny Applications/Presentations


## What is R Shiny?  

  - [R Shiny Package](http://shiny.rstudio.com/) allows for creation of interactive "web" applications in R  

  - Developed by RStudio  
  
  - Basically a folder with 2 R scripts: 
      + $\texttt{ui.R}$ (User Interface)
      + $\texttt{server.R}$ (R functions that run/respond to UI)
  - Requires no HTML, CSS, or JavaScript!
  
    
## Example App
```{r eruptions}
inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20),
  
  sliderInput("bw_adjust", label = "Bandwidth adjustment:",
              min = 0.2, max = 2, value = 1, step = 0.2)
)

renderPlot({
  hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks),
       xlab = "Duration (minutes)", main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = input$bw_adjust)
  lines(dens, col = "blue")
})
```

        
## Why use R Shiny?  

  - If you know R, not too bad to learn  
  
  - Can be great way to    
    
    + Share data analysis results  

    + Allow user to explore data  
    
    + Explain statistical concepts/teach  


##Ex: Multiple Linear Regression Idea    
<div style="margin-left:-20px; margin-top:-50px; margin-right: -20px; margin-bottom: -50px; height: 100%;">  

```{r MLR,echo=FALSE,message=FALSE, warning=FALSE}
library(shiny)
library(shinydashboard)
library(plotly)
library(dplyr)
library(ggplot2)
library(plot3D)
data<-read_csv("https://raw.githubusercontent.com/jbpost2/IntermediateR/master/datasets/river.csv")
data<-data[,c(-3:-1)]
#function to get RHS of formula for two pred part
addFormula<-function(formula,condition){
  if(condition>0){
    val<-deparse(substitute(condition))
    if(formula=="y~"){
      if((val=="x1x1")||(val=="x2x2")){
        form<-paste0(formula,paste(substr(val,start=1,stop=2),substr(val,start=3,stop=4),sep="*"))
      } else if(val=="x1x2"){
        form<-paste0(formula,paste("x1*x2"))
      } else if(val=="x1x1x2x2"){
        form<-paste0(formula,paste("x1*x1*x2*x2"))
      } else {
        form<-paste0(formula,val)
      }
    } else { 
      if(val=="x1"||val=="x2"){
        form<-paste(formula,paste0(val),sep="+")
      } else if(val=="x1x1"||val=="x2x2"||val=="x1x2"){
        form<-paste(formula,paste(substr(val,start=1,stop=2),substr(val,start=3,stop=4),sep="*"),sep="+")
      } else if(val=="x1x1x2x2"){
        form<-paste(formula,"x1*x1*x2*x2",sep="+")
      }
    }
    as.formula(form)
  } else {
    formula
  }
}

shinyApp(
# Define UI for application that displays an about page and the app itself

dashboardPage(skin="red",
  #add title
  dashboardHeader(title="Visualizing Regression",titleWidth=750),
              
  #define sidebar items
  dashboardSidebar(sidebarMenu(
    menuItem("One Variable Regression", tabName = "appOneVar", icon = icon("laptop")),
    menuItem("Two Variable Regression", tabName = "appTwoVar", icon = icon("laptop"))
  )),
              
  #define the body of the app
  dashboardBody(
    tabItems(
      #actual app layout for One Variable part   
      tabItem(tabName = "appOneVar",
        fluidRow(
          column(3,br(),
            selectInput("xOneVar","Explanatory Variable (x)",choices=NULL,selected=NULL,multiple=FALSE),
            selectInput("yOneVar","Response Variable (y)",choices=NULL,selected=NULL,multiple=FALSE),
            checkboxInput("oneVarReg",'Fit Regression Equation?',value=FALSE),
            conditionalPanel(condition= "input.oneVarReg",
              numericInput("oneVarPreds","Degree Polynomial",value=0,step=1,max=4,min=0))
          ),
        
          #Show the scatter plot  
          column(9,
            fluidRow(
              box(width=12,plotlyOutput("oneVarPlot"))
            ), 
            fluidRow(
              box(width=12,title="Fitted Regression Equation",uiOutput("oneVarEq"))),
            fluidRow(
              box(width=12,title="Coefficient Information for Model",tableOutput("oneVarCoef"))
            )
          )
        )
      ),
      #actual app layout for Two Variable part   
      tabItem(tabName = "appTwoVar",
        fluidRow(
          column(3,br(),
             selectInput("xTwoVar1","Explanatory Variable (x1)",choices=NULL,selected=NULL,multiple=FALSE),
             selectInput("xTwoVar2","Explanatory Variable (x2)",choices=NULL,selected=NULL,multiple=FALSE),
             selectInput("yTwoVar","Response Variable (y)",choices=NULL,selected=NULL,multiple=FALSE),
             sliderInput("theta",label="Viewing Angle",min=0,max=360,value=20,animate=TRUE),
             sliderInput("phi",label="Viewing Angle",min=0,max=360,value=20,animate=TRUE),
             checkboxInput("twoVarReg",'Fit Regression Equation?',value=FALSE),
             conditionalPanel(condition = "input.twoVarReg",
                selectizeInput("twoVarPreds","Model to Fit",choices=c("y~x1","y~x2","y~x1+I(x1^2)","y~x2+I(x2^2)","y~x1+x2","y~x1+x2+x1*x2","y~x1+x2+x1*x2+I(x1^2*x2)","y~x1+x2+x1*x2+I(x1*x2^2)","y~x1+x2+x1*x2+I(x1^2*x2)+I(x1*x2^2)+I(x1^2*x2^2)"),selected="y~x1+x2")
              )
          ),
                
          #Show the scatter plot  
          column(9,
            fluidRow(
              box(width=12,plotOutput("twoVarPlot"))
            ), 
            fluidRow(
              box(width=12,title="Fitted Regression Equation",uiOutput("twoVarEq"))),
            fluidRow(
              box(width=12,title="ANOVA Table for Model",tableOutput("twoVarANOVA"))
           )
          )
        )
      )
    )
  )
),

# Define server logic required to draw the plots etc
shinyServer(function(input, output,session) {
 
  #populate/update ui
  observe({
    
    updateSelectInput(session,"xOneVar","Explanatory Variable (x)",choices=names(data)[sapply(data,is.numeric)],selected=names(data)[sapply(data,is.numeric)][1])

    updateSelectInput(session,"yOneVar","Response Variable (y)",choices=names(data)[sapply(data,is.numeric)],selected=names(data)[sapply(data,is.numeric)][2])
  
    updateSelectInput(session,"xTwoVar1","Explanatory Variable (x1)",choices=names(data)[sapply(data,is.numeric)],selected=names(data)[sapply(data,is.numeric)][1])

    updateSelectInput(session,"xTwoVar2","Explanatory Variable (x2)",choices=names(data)[sapply(data,is.numeric)],selected=names(data)[sapply(data,is.numeric)][2])

    updateSelectInput(session,"yTwoVar","Response Variable (y)",choices=names(data)[sapply(data,is.numeric)],selected=names(data)[sapply(data,is.numeric)][3])
    
  })
  

  ###################################################
  #One var section
  
  #create plot
  output$oneVarPlot<-renderPlotly({
    #get inputs
    x<-input$xOneVar
    y<-input$yOneVar
    dataTemp<-na.omit(data[,c(x,y)])
    datax<-dataTemp[,x][[1]]
    datay<-dataTemp[,y][[1]]
    if(input$oneVarReg){
      degree<-input$oneVarPreds
      if(degree==0){
        #plot
        dataTemp %>% plot_ly(x = ~datax) %>% 
          add_markers(y = ~datay) %>%
          add_lines(x = ~datax,y = ~mean(datay)) %>%
          layout(xaxis=list(title=paste(x)),yaxis=list(title=paste(y)))
      } else if(degree==1){
        fit<-lm(datay~datax,data=data)
        xs<-seq(from=min(datax),to=max(datax),length=1000)
        ys<-rep(coef(fit)[1],length(xs))+coef(fit)[2]*xs

        #plot
        dataTemp %>% plot_ly(x = ~datax) %>% 
          add_markers(y = ~datay) %>%
          add_lines(x = ~xs,y = ~ys) %>%
          layout(xaxis=list(title=paste(x)),yaxis=list(title=paste(y)))
        
      } else if(degree==2){
        data2=datax^2
        tempData<-data.frame(dataTemp,data2=data2)
        
        fit<-lm(tempData[,y]~tempData[,x]+data2,data=tempData)
        xs<-seq(from=min(datax),to=max(datax),length=1000)
        ys<-rep(coef(fit)[1],length(xs))+coef(fit)[2]*xs+coef(fit)[3]*xs^2

        #plot
        dataTemp %>% plot_ly(x = ~datax) %>%
          add_markers(y = ~datay) %>%
          add_lines(x = ~xs,y = ~ys,data=data.frame(xs,ys))%>%
          layout(xaxis=list(title=paste(x)),yaxis=list(title=paste(y)))
        
      } else if(degree==3){
        data2=datax^2
        data3=datax^3
        tempData<-data.frame(dataTemp,data2=data2,data3=data3)
        
        fit<-lm(tempData[,y]~tempData[,x]+data2+data3,data=tempData)
        xs<-seq(from=min(datax),to=max(datax),length=1000)
        ys<-rep(coef(fit)[1],length(xs))+coef(fit)[2]*xs+coef(fit)[3]*xs^2+coef(fit)[4]*xs^3
        
        #plot
        dataTemp %>% plot_ly(x = ~datax) %>%
          add_markers(y = ~datay) %>%
          add_lines(x = ~xs,y = ~ys,data=data.frame(xs,ys))%>%
          layout(xaxis=list(title=paste(x)),yaxis=list(title=paste(y)))
        
      } else if(degree==4){
        data2=datax^2
        data3=datax^3
        data4=datax^4

        tempData<-data.frame(dataTemp,data2=data2,data3=data3,data4=data4)

        fit<-lm(tempData[,y]~tempData[,x]+data2+data3+data4,data=tempData)
        xs<-seq(from=min(datax),to=max(datax),length=1000)
        ys<-rep(coef(fit)[1],length(xs))+coef(fit)[2]*xs+coef(fit)[3]*xs^2+coef(fit)[4]*xs^3+coef(fit)[5]*xs^4

        #plot
        dataTemp %>% plot_ly(x = ~datax) %>%
          add_markers(y = ~datay) %>%
          add_lines(x = ~xs,y = ~ys)%>%
          layout(xaxis=list(title=paste(x)),yaxis=list(title=paste(y)))
      } 
    } else{
      dataTemp %>% plot_ly(x = datax) %>% add_markers(y = datay)%>%
        layout(xaxis=list(title=paste(x)),yaxis=list(title=paste(y)))
    }
  })
  
  
  #create regression equation or return string
  output$oneVarEq<-renderUI({
    #get inputs
    x<-input$xOneVar
    y<-input$yOneVar
    datax<-data[,x][[1]]
    datay<-data[,y][[1]]
    
    if(input$oneVarReg){
      degree<-input$oneVarPreds

      if(degree==0){
        fit<-lm(datay~1,data=data)
        #return equation
        withMathJax(HTML(paste0('$$\\hat{y} = ',paste(signif(fit$coef,6),collapse=" + "),'$$'))) 
      } else if(degree==1){
        fit<-lm(datay~datax,data=data)
        #return equation
        fit$coef<-signif(fit$coef,6)
        withMathJax(HTML(paste0('$$\\hat{y} = ',paste(fit$coef[1],paste(fit$coef[2],'x',sep="*"),sep=" + "),'$$'))) 
      } else if(degree==2){
        data2=datax^2
        tempData<-data.frame(data,data2=data2)
        
        fit<-lm(tempData[,y]~tempData[,x]+data2,data=tempData)
        fit$coef<-signif(fit$coef,6)
        #return equation
        withMathJax(HTML(paste0('$$\\hat{y} = ',paste(fit$coef[1],paste(fit$coef[2],'x',sep="*"),paste(fit$coef[3],'x^2',sep="*"),sep=" + "),'$$'))) 
      } else if(degree==3){
        data2=datax^2
        data3=datax^3
        tempData<-data.frame(data,data2=data2,data3=data3)
        
        fit<-lm(tempData[,y]~tempData[,x]+data2+data3,data=tempData)
        fit$coef<-signif(fit$coef,6)
        #return equation
        withMathJax(HTML(paste0('$$\\hat{y} = ',paste(fit$coef[1],paste(fit$coef[2],'x',sep="*"),paste(fit$coef[3],'x^2',sep="*"),paste(fit$coef[4],'x^3',sep="*"),sep=" + "),'$$'))) 
      }else if(degree==4){
        data2=datax^2
        data3=datax^3
        data4=datax^4
        
        tempData<-data.frame(data,data2=data2,data3=data3,data4=data4)
        
        fit<-lm(tempData[,y]~tempData[,x]+data2+data3+data4,data=tempData)
        fit$coef<-signif(fit$coef,6)
        #return equation
        withMathJax(HTML(paste0('$$\\hat{y} = ',paste(fit$coef[1],paste(fit$coef[2],'x',sep="*"),paste(fit$coef[3],'x^2',sep="*"),paste(fit$coef[4],'x^3',sep="*"),paste(fit$coef[5],'x^4',sep="*"),collapse=" + "),'$$')))
      }
    } else {
      paste("No regression fit selected.")
    }
  })
  
  #get coef table
  output$oneVarCoef<-renderTable(include.rownames=TRUE,{
    #get inputs
    x<-input$xOneVar
    y<-input$yOneVar
    datax<-data[,x][[1]]
    datay<-data[,y][[1]]

    if(input$oneVarReg){
      degree<-input$oneVarPreds
      
      if(degree==0){
        fit<-lm(datay~1,data=data)
        info<-as.data.frame(summary(fit)$coefficients)
        row.names(info)<-c("Intercept")
      } else if(degree==1){
        fit<-lm(datay~datax,data=data)
        info<-as.data.frame(summary(fit)$coefficients)
        row.names(info)<-c("Intercept","Linear")
      } else if(degree==2){
        data2=datax^2
        tempData<-data.frame(data,data2=data2)
        fit<-lm(tempData[,y]~tempData[,x]+data2,data=tempData)
        info<-as.data.frame(summary(fit)$coefficients)
        row.names(info)<-c("Intercept","Linear","Quadratic")
        
      } else if(degree==3){
        data2=datax^2
        data3=datax^3
        tempData<-data.frame(data,data2=data2,data3=data3)
        fit<-lm(tempData[,y]~tempData[,x]+data2+data3,data=tempData)
        info<-as.data.frame(summary(fit)$coefficients)
        row.names(info)<-c("Intercept","Linear","Quadratic","Cubic")
      }else if(degree==4){
        data2=datax^2
        data3=datax^3
        data4=datax^4
        tempData<-data.frame(data,data2=data2,data3=data3,data4=data4)
        fit<-lm(tempData[,y]~tempData[,x]+data2+data3+data4,data=tempData)
        info<-as.data.frame(summary(fit)$coefficients)
        row.names(info)<-c("Intercept","Linear","Quadratic","Cubic","Quartic")
      }
      info
    } else {
      data.frame(Message="No regression fit selected.")
    }
  })
  
  ###################################################
  #Two Var part
  
  #create plot 
  output$twoVarPlot<-renderPlot({
    #get inputs
    x1<-input$xTwoVar1
    x2<-input$xTwoVar2
    y<-input$yTwoVar
    dataTemp<-na.omit(data[,c(x1,x2,y)])
    datax1<-dataTemp[,x1][[1]]
    datax2<-dataTemp[,x2][[1]]
    datay<-dataTemp[,y][[1]]
    
    if(input$twoVarReg){
      theta<-input$theta
      phi<-input$phi
      
      fit<-fitter()
      grid.lines = 40
      x1.pred <- seq(min(datax1), max(datax1), length.out = grid.lines)
      x2.pred <- seq(min(datax2), max(datax2), length.out = grid.lines)
      x1x2 <- expand.grid(x1.pred, x2.pred)
      names(x1x2)<-c("x1","x2")
      y.pred <- matrix(predict(fit, newdata = x1x2), 
                       nrow = grid.lines, ncol = grid.lines)
      
      scatter3D(x=datax1, y=datax2, z=datay, pch = 16, cex = 1, theta = theta, 
                phi = phi, ticktype = "detailed",
                xlab = input$xTwoVar1, ylab = input$xTwoVar2, 
                zlab = input$yTwoVar,
                surf = list(x = x1.pred, y = x2.pred, z = y.pred))
      

      #plot_ly(x = ~datax1, y = ~datax2, z= ~datay) #%>%
        #add_surface(z=plane)
      
    } else {
      scatter3D(x=datax1, y=datax2, z=datay, pch = 16, cex = 1, 
                theta = input$theta, phi = input$phi, ticktype = "detailed",
                xlab = input$xTwoVar1, ylab = input$xTwoVar2, zlab = input$yTwoVar)
      # data %>% plot_ly(x = ~datax1, y = ~datax2, z= ~datay)# %>%
      # layout(title = "3-D Scatterplot",
      #      scene = list(
      #        xaxis = list(title = "x1"), 
      #        yaxis = list(title = "x2"), 
      #        zaxis = list(title = "y")))
    }
    
  })
  
  
  
  fitter <- reactive({
    if(input$twoVarReg){    
      #get inputs
      x1<-input$xTwoVar1
      x2<-input$xTwoVar2
      y<-input$yTwoVar
      dataTemp<-na.omit(data[,c(x1,x2,y)])
      names(dataTemp)<-c("x1","x2","y")
      terms<-input$twoVarPreds
      fit<-lm(as.formula(terms),data=dataTemp)
    return(fit)
    }
  })
  
  
  
  #create regression equation or return string
  output$twoVarEq<-renderUI({

    if(input$twoVarReg){     
      fit<-fitter()
      fit$coef<-signif(fit$coef,5)
      terms<-input$twoVarPreds
      tagList(tags$p(terms),tags$p(paste0(fit$coef,collapse=",")))
    } else {
      paste("No regression fit selected.")
    }
  })
  
  #get ANOVA table
  output$twoVarANOVA<-renderTable(rownames=TRUE,{
    fit<-fitter()
    if(is.null(fit)){
      "No regression fit selected."
      } else {
        anova(fit)
      }
  })
  
})    
)
```  

</div>

## How to Develop R Shiny Apps

  * Explore online repositories/resources for existing apps!  

  * Create a basic app  

  * Customize apps  

  * Learn solutions to common issues when creating apps  

  * Deploy the app

##Available Apps  

  - Many available resources!!  
  
  - [Apps I've created](http://www4.stat.ncsu.edu/~post/ShinyWorkshop/apps.html)
  
  - Plenty of good examples  
     + [Shiny Showcase](https://www.rstudio.com/products/shiny/shiny-user-showcase/)  
     + [Shiny Gallery](https://shiny.rstudio.com/gallery/)  
     + [Stat Concepts](https://github.com/gastonstat/shiny-introstats/)  
     + [More Stat Concepts](https://www.researchgate.net/publication/298786680_Web_Application_Teaching_Tools_for_Statistics_Using_R_and_Shiny)  
     + [Cal Poly](http://www.statistics.calpoly.edu/shiny)

  - Take a few minutes to explore some apps!  
  

##Getting Started - Basic Needs  
  *  R, R studio   
  
  *  `shiny` package   
  
  *  Recommended other packages   
  
      + `shinydashboard` (create dashboards)    

      +  `DT` (Nice Tables)        


##Elements of an App
  - Each app has two things
    * User Interface (UI) 
    * Server     

##App Duties  
```{r appRep.png, out.width = "750px"}
knitr::include_graphics("img/appRep.PNG")
```  

##Elements of an App
  - Each app has two things
    * User Interface (UI) 
    * Server     
    
  - UI determines **layout** of app  
      + Sets up widgets (items users can interact with)  


##Elements of an App
  - Each app has two things
    * User Interface (UI) 
    * Server     
    
  - UI determines **layout** of app  
      + Sets up widgets (items users can interact with)  
  
  - Server contains R code to **run for the app**  
      + Can include plots, model fitting, any R code really...  


##Elements of an App
  - Each app has two things
    * User Interface (UI) 
    * Server     
    
  - UI determines **layout** of app  
      + Sets up widgets (items users can interact with)  
  
  - Server contains R code to **run for the app**  
      + Can include plots, model fitting, etc.  
    
  - Can do with single file (`app.R`) but we'll use a separate file (`ui.R` and `server.R`)


##Two File Approach (Recommended)  

 - Create folder for each App   

 - Each App's folder should have `ui.R` and `server.R` files  
 
 - If single file, `app.R`  

***  
![](img/folderStructure.PNG)


##`ui.R` Basic Layout
```{r basic-ui,eval=FALSE,echo=TRUE}
library(shiny)

ui <- fluidPage(
	titlePanel(), 
	
  sidebarLayout(
    sidebarPanel(#usually widgets
      ),
    mainPanel(#usually output
      )
  )
)
```


##UI Common Layout  
```{r layout,echo=FALSE}
shinyUI(fluidPage(
  titlePanel("title panel"),

  sidebarLayout(
    sidebarPanel( "sidebar panel",br(),"|",
              br(),"|",br(),"|",br(),"|",br(),"|",br(),"|",br(),"V",br(),"Usually User Inputs"),
    mainPanel("main panel content-------------------->",br(),"|",
              br(),"|",br(),"|",br(),"|        Usually Output",br(),"|        that Reacts to User Input",br(),"|",br(),"V")
  )
))
``` 


##`server.R` Basic File  
```{r basic-server,eval=FALSE,echo=TRUE}
library(shiny)

shinyServer(function(input, output, session) {

})
```  

##Shiny Templates  
Readily available in R studio  
![](img/templates.PNG)  

##Two File Template
```{r two-file-template-ui,eval=FALSE,echo=TRUE}
library(shiny)
ui <- fluidPage(
   # Application title
   titlePanel("Old Faithful Geyser Data"),
   # Sidebar with a slider input for number of bins 
   sidebarLayout(
      sidebarPanel(
         sliderInput("bins",
                     "Number of bins:",
                     min = 1,
                     max = 50,
                     value = 30)
      ),
      # Show a plot of the generated distribution
      mainPanel(
         plotOutput("distPlot")
      )
   )
)
```

##Two File Template  
```{r two-file-template-server,eval=FALSE,echo=TRUE}
# Define server logic required to draw a histogram
server <- function(input, output) {
   output$distPlot <- renderPlot({
      # generate bins based on input$bins from ui.R
      x    <- faithful[, 2] 
      bins <- seq(min(x), max(x), length.out = input$bins + 1)
      
      # draw the histogram with the specified number of bins
      hist(x, breaks = bins, col = 'darkgray', border = 'white')
   })
}
```  

##Running an App  
  - While `ui.R` or `server.R` is your active window, click the **Run App** button  
  ![](img/runAppButton.PNG) 
  

##Running an App  
  - While `ui.R` or `server.R` is your active window, click the **Run App** button  
  ![](img/runAppButton.PNG)    
  
  - Set working directory to ShinyApps folder  
  - Load `shiny` package  
  - Use `runApp()` function  
     * ex: `runApp("normalPower")`   


##Running an App  
  - While `ui.R` or `server.R` is your active window, click the **Run App** button  
  ![](img/runAppButton.PNG)    
  
  - Set working directory to ShinyApps folder  
  - Load `shiny` package  
  - Use `runApp()` function  
     * ex: `runApp("normalPower")`   

  - Running App will tie up R console!  
  - End by hitting Esc or closing shiny app  
  
  > - Take a minute and run the template app


##Adding to the UI    
Using a comma to separate items, you can add  

- Any plain strings  
- Widgets  
- Formatted text (using HTML type functions)  
  ![](img/tags.PNG)  
- Output from things created in the `server.R` file  
  
  
##Adding to the UI - Widgets  
  - Widgets can be added using their `*Input` functions  
  - Separate widgets (and other items) by commas in ui.R file


##Adding to the UI - Widgets  
  - Widgets can be added using their `*Input` functions  
  - Separate widgets (and other items) by commas in ui.R file
  ![](img/widgets.PNG)  
  
  
***
<div style="margin-left:-20px; margin-top:-50px; margin-right: -20px; margin-bottom: -50px; height: 100%;">  

```{r widget-app,echo=FALSE,message=FALSE}
library(shiny)
library(rvest)

#function to get help file and format
helpFile<-function(site){
  code<-read_html(site)
  title<-html_node(code,"body") %>% html_node("h1") %>% html_text()
  rcode<-html_node(code,"body") %>% html_node("pre")
  args<-html_node(code,"body") %>% html_node("table")
  as.character(paste(paste0("<h3>",title,"</h3>"),"<h4>Usage</h4>",rcode,"<h4>Arguments</h4>",args,sep=" "))
}

# Define UI for application that draws a histogram
shinyApp(
  # Define UI for application that draws a histogram
  ui <- fluidPage(
     # Application title
     titlePanel(h1("Shiny Widgets for the UI")),
     
     # Sidebar with a slider input for number of bins 
     fluidRow(
       column(6,
          fluidRow(
            column(6,selectizeInput("widget", label = h2("Widget"),
                        choices = c("Button","Check Box","Check Box Group","Date Input","Date Range","File Input","Numeric Input","Radio Button","Select Box","Slider","Text Input"), selected = "Button")
           ),
            column(6,
              conditionalPanel(condition="input.widget == 'Button'",actionButton("B",h3("Click Here!"))),
              conditionalPanel(condition="input.widget == 'Check Box'",checkboxInput("CB",label=h3("Add Element"),value=FALSE,width='100%')),
              conditionalPanel(condition="input.widget == 'Check Box Group'",checkboxGroupInput("CBG",h3("Select From the Choices Below"),choices=list("Option A","Option B","Option C","Option D"),width='100%')),
              conditionalPanel(condition="input.widget == 'Date Input'",dateInput("DI",h3("Input a Date Here",style="border-style:outset"),value='2016-11-122')),
              conditionalPanel(condition="input.widget == 'Date Range'",dateRangeInput("DR",h3("Input Dates Here",style="border-style:inset"),start='1983-11-14')),
              conditionalPanel(condition="input.widget == 'File Input'",fileInput("FI",h3("Select File to Input"))),
              conditionalPanel(condition="input.widget == 'Numeric Input'",numericInput("NI",h3("Enter a Number Between 0 and 1000"),value=0,min=0,max=1000,step=5)),
              conditionalPanel(condition="input.widget == 'Radio Button'",radioButtons("RB",h3("Select a Choice Below",style="background-color:lightblue;border-style:dotted"),choices=list("Option A","Option B","Option C","Option D"))),
              conditionalPanel(condition="input.widget == 'Select Box'",selectInput("SB",h3("Select From the Group Below"),choices=list("Option A","Option B","Option C","Option D"),multiple=TRUE)),
              conditionalPanel(condition="input.widget == 'Slider'",sliderInput("S",h3("Use the Slider to Select a Range",style="font-family: Courier New"),min=0, max=1000,value=100,animate=TRUE,step=5)),
              conditionalPanel(condition="input.widget == 'Text Input'",textInput("TI",h3("Write Your Text Below",style="color:blue")))
            )
           ),
          tags$hr(),
          fluidRow(
            column(12,h2("Code Used for Widget Above"),
              verbatimTextOutput("userInput")
            )
          ),
          fluidRow(
            column(12,h2("What does Shiny return for use?"),
              verbatimTextOutput("widgetValue")
            )
          )
       ),
       column(6,h2("Help Information for Widget"),
        uiOutput("widgetInfo")
       )
     )
  ),

    
  # Define server logic required to draw a histogram
  server <- function(input, output,session) {
   
    output$widgetValue<-renderPrint({
      if(input$widget=="Button"){
         list(input$B)
      } else if(input$widget=="Check Box"){
        list(input$CB)
      } else if(input$widget=="Check Box Group"){
        list(input$CBG)
      } else if(input$widget=="Date Input"){
        list(input$DI)
      } else if(input$widget=="Date Range"){
        list(input$DR)
      } else if(input$widget=="File Input"){
        list(input$FI)
      } else if(input$widget=="Numeric Input"){
        list(input$NI)
      } else if(input$widget=="Radio Button"){
        list(input$RB)
      } else if(input$widget=="Select Box"){
        list(input$SB)
      } else if(input$widget=="Slider"){
        list(input$S)
      } else if(input$widget=="Text Input"){
        list(input$TI)
      }
    })
    
  
  output$widgetInfo<-renderText({
      if(input$widget=="Button"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/actionButton.html")
      } else if(input$widget=="Check Box"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/checkboxInput.html")
      } else if(input$widget=="Check Box Group"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/checkboxGroupInput.html")
      } else if(input$widget=="Date Input"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/dateInput.html")
      } else if(input$widget=="Date Range"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/dateRangeInput.html")
      } else if(input$widget=="File Input"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/fileInput.html")
      } else if(input$widget=="Numeric Input"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/numericInput.html")
      } else if(input$widget=="Radio Button"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/radioButtons.html")
      } else if(input$widget=="Select Box"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/selectInput.html")
      } else if(input$widget=="Slider"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/sliderInput.html")
      } else if(input$widget=="Text Input"){
        helpFile("https://shiny.rstudio.com/reference/shiny/latest/textInput.html")
      }
    })
  
  output$userInput<-renderText({
    if(input$widget=="Button"){
      'actionButton("B",h3("Click Here!"))'
    } else if(input$widget=="Check Box"){
      'checkboxInput("CB",label=h3("Add Element"),value=FALSE,width="100%")'
    } else if(input$widget == 'Check Box Group'){
      'checkboxGroupInput("CBG",h3("Select From the Choices Below"),choices=list("Option A","Option B","Option C","Option D"),width="100%"))'
    } else if(input$widget == 'Date Input'){
      'dateInput("DI",h3("Input a Date Here",style="border-style:outset"),value="2016-11-122"))'
    } else if(input$widget == 'Date Range'){
      'dateRangeInput("DR",h3("Input Dates Here",style="border-style:inset"),start="1983-11-14"))'
    } else if(input$widget == 'File Input'){
    'fileInput("FI",h3("Select File to Input")))'
    } else if(input$widget == 'Numeric Input'){
      'numericInput("NI",h3("Enter a Number Between 0 and 1000"),value=0,min=0,max=1000,step=5))'
    } else if(input$widget == 'Radio Button'){
    'radioButtons("RB",h3("Select a Choice Below",style="background-color:lightblue;border-style:dotted"),choices=list("Option A","Option B","Option C","Option D")))'
    } else if(input$widget ==  'Select Box'){
      'selectInput("SB",h3("Select From the Group Below"),choices=list("Option A","Option B","Option C","Option D"),multiple=TRUE))'
    } else if(input$widget == 'Slider'){
      'sliderInput("S",h3("Use the Slider to Select a Range",style="font-family: Courier New"),min=0, max=1000,value=100,animate=TRUE,step=5))'
    } else if(input$widget == 'Text Input'){
      'textInput("TI",h3("Write Your Text Below",style="color:blue"))'
    }
  })
  }
)
```  

</div>


##Sharing Between Server and UI  

- Widgets are used to take input from the user  

- Use their values in `server.R` (has your analysis or vis code!)  

- Functions in `server.R` will create output to go in the `ui.R`  

    
##Sharing Between Server and UI  
![](img/outputsUI.PNG)  

##Adding to the UI - Example Syntax
```{r ui-syntax,echo=TRUE,eval=FALSE}
library(shiny)
ui <- fluidPage(
  sidebarLayout(
    sidebarPanel(
      h2("Widgets/Text"),
      numericInput("NI",label="Intercept",value=10),
      sliderInput("SI",label="Slope",min=-1,max=1,value=0,step=0.1),
      "More text",
      br(),
      a(href="http://www.rstudio.com",target="_blank","Link to RStudio")
    ),
    mainPanel(plotOutput("dataPlot"), #dataPlot is name of "plot" object in server
              textOutput("dataInfo"), #dataInfo is name of "text" object in server
              dataTableOutput("dataTable") #dataTable is name of "data" object in server
    )
  )
)
```

***
```{r,eval=TRUE,echo=FALSE,message=FALSE}
library(shiny)
library(DT)
library(ggplot2)
shinyApp(
  ui <- fluidPage(
    sidebarLayout(
      sidebarPanel(
        h2("Widgets/Text"),
        numericInput("NI",label="Intercept",value=10),
        sliderInput("SI",label="Slope",min=-1,max=1,value=0,step=0.1),
        "More text",
        br(),
        a(href="http://www.rstudio.com",target="_blank","Link to RStudio")
      ),
      mainPanel(plotOutput("dataPlot"), #dataPlot is name of "plot" object in server
                h3(textOutput("dataInfo")), #dataInfo is name of "text" object in server
                dataTableOutput("dataTable") #dataTable is name of "data" object in server
      )
    )
  ),
  shinyServer(function(input, output,session) {
    
    dataSet<-reactive({
      #get inputs
      intercept<-input$NI
      slope<-input$SI
      
      x<-rnorm(100)
      y<-intercept+slope*x+rnorm(100)
      
      data.frame(y=y,x=x)
    })
    
    #create plot
    output$dataPlot<-renderPlot({
      data<-dataSet()
      
      fit<-lm(data$y~data$x)
      p<-ggplot(data=data,aes(x=data$x,y=data$y))+geom_point()+geom_smooth(method=lm)
      p
    })
    
    output$dataInfo<-renderText(paste0("The true intercept is ",input$NI,".  The true slope is ",input$SI,"."))
    
    output$dataTable<-renderDataTable(dataSet())
  })
)
```

##Summary So Far   
`ui.r`    

  - Controls layout of app    

  - Basic layout uses a sidebar panel and a main panel    

  - Use strings, formatted (html style) text, widgets (`input*` functions), and output from `server.r`  (`*Output` functions)    

  - Separate items with commas      


## Activity 

- [**UI Set-up Activity** instructions](http://www4.stat.ncsu.edu/~post/IntermediateR/UISetUpActivity.html) available on web  

- Work in small groups  

- Ask questions!  TAs and I will float about the room  

- Feel free to ask questions about anything you didn't understand as well!   


##Server file  
`server.r` also called the 'back-end' because it works behind-the-scenes; its actions are not directly visible

```{r server-basics, eval=FALSE,echo=TRUE}
## set up server
shinyServer(function(input, output, session) {
  # add stuff
})
```



##Server file  
`server.r` also called the 'back-end' because it works behind-the-scenes

```{r server-basics2, eval=FALSE,echo=TRUE}
## set up server
shinyServer(function(input, output, session) {
  # add stuff
})
```

The arguments for the server are `input`, `output`, and `session`.  Allow us to    

  1. Take in inputs from the UI        
  
  2. Run functions on them     
  
  3. Create outputs to send back     
  


##Creating Output to Send to UI  
![](img/outputsUI.PNG)  

##Creating Output to Send to UI
Example syntax
```{r server-syntax,echo=TRUE,eval=FALSE}
shinyServer(function(input,output){
  output$nameOfOutputObject<-renderPlot(
    #code that will return a plot
  )
  
  output$otherOutput<-renderText(
    #code that will return something that R can coerce to a string
  )
})

#in ui.r file, reference would look like
plotOutput("nameOfOutputObject")
textOutput("otherOutput")
```

##Accessing Input Values in server.R
 - Every input object has an `inputID`


##Accessing Input Values in server.R
 - Every input object has an `inputID`
 - In `server.r`, reference input value by
```{r input-ref,echo=TRUE,eval=FALSE}
input$inputID
```


##Accessing Input Values in server.R
 - Every input object has an `inputID`
 - In `server.r`, reference input value by
```{r input-ref2,echo=TRUE,eval=FALSE}
input$inputID
```
 - Example
```{r input-ref-ex,echo=TRUE,eval=FALSE}
#input widget code from ui.r file
sliderInput(inputID = "slide",label = "Select the Range Here",min = 0,max = 1,
            value = c(0,1))
#reference in server.r might look like
output$userPlot<-renderPlot({
  range<-input$slide
  #create plot that changes based on user input
  plot(data,xlim=range)  
})
```  


##Input and Output  
 -  `input` and `output` objects are kind of like **lists**  
 
> -  Shiny passes the information back and forth through them  


##Input and Output  
 -  `input` and `output` objects are kind of like **lists**  
 -  Shiny passes the information back and forth through them  
 -  Notice how we name our output objects  
```{r naming,echo=TRUE,eval=FALSE}
output$nameOfOutputObject<-renderPlot(...))  
```    


##Input and Output  
 -  `input` and `output` objects are kind of like **lists**  
 -  Shiny passes the information back and forth through them  
 -  Notice how we name our output objects  
```{r naming2,echo=TRUE,eval=FALSE}
output$nameOfOutputObject<-renderPlot(...))  
```    
 - Notice how we access our inputs
```{r accessing,echo=TRUE,eval=FALSE}
output$nameOfOutputObject<-renderPlot(
   range<-input$slide
))  
```    


##Quick Try  

- Using the template app  

- Add text output object in the `server.R` file (use `renderText`) that returns the current value of the input slider   

- To do this, just reference the input (like an R function, it will return the last thing you do)  

- Don't forget to add a `textOutput` in the `ui.R` file!  


##Reactivity  
 - Output objects do not have to depend on an input    

 - Those that don't will be static    
 
> - Any 'chunk' of code in `server.r` that references a user input must be **reactive**   

> - When a user changes the reference, the code **re-evaluates**  

##Example Reactivity
```{r reactivity,echo=TRUE,eval=FALSE}

##code chunk "reacts" to and re-evaluates if 
##input$sampleSize or input$otherInput changes 

output$dataPlot<-renderPlot({

  n<-input$sampleSize
  input$otherInput #not used anywhere else, but entire   
                   #renderPlot chunk still re-evaluates
                   #if changed
  
  hist(rbinom(n=1,size=n,prob=0.4))
  
})
```

- type `runApp("01_hello")` (load `shiny` library 1st: `library(shiny)`)

##Reactivity  
 - Reactive variables (user inputs) can only be used in reactive contexts    
 
> - All `render*` functions are reactive contexts    

> - `server.r` can run any R code, but can't access inputs unless put into a reactive context    
 
 
##Error Using Reactive Variables  
Following returns the error:

```{r bad-reactivity,echo=TRUE,eval=FALSE}
shinyApp(ui<-fluidPage(
                numericInput("NI","Give me a number",value = 10),
                textOutput("string")
                ),
         
         shinyServer(function(input,output){
                print(input$NI+10)
                output$string<-renderText(paste("value plus 10 is",input$NI+10))
         }
))
```
Warning: Error in .getReactiveEnvironment()$currentContext: Operation not allowed without an active reactive context. (You tried to do something that can only be done from inside a reactive expression or observer.)  


##Other Reactive Contexts  
 -  `reactive({})` function allows for reactivity and creation of a new variable  
  -  `observe({})` function allows for reactivity    

```{r observe, echo = TRUE, eval = FALSE}
shinyServer(function(input,output){

  #Creates a new reactive variable
  newVar<-reactive({
    value<-c(input$NI+10,input$NI*3)
  })

    #would now print to console
  observe({print(input$NI+10)})
  
  output$textString<-renderText({
    value<-newVar()  #access like a function!
    paste0("Input plus 10 is ",value[1]," and Input times 3 is ",value[2])
  })
}
```
 
##More on `reactive({})`

  - 'Wraps' a normal expression to create a reactive expression (code user can cause to change)     
  
 > - Can read reactive values and call other reactive expressions    
 
 > - Only re-evaluates *if necessary*    
 
 > - Access object as though calling it as a function  


##More on `reactive({})`

- Access object as though calling it as a function  
  
```{r reactive,echo=TRUE,eval=FALSE}
shinyServer(function(input,output){
  #Creates a new reactive variable
  newVar<-reactive({
    value<-c(input$NI+10,input$NI*3)
  })

  output$textString<-renderText({
    value<-newVar()  #access like a function!
    paste0("Input plus 10 is ",value[1]," and Input times 3 is ",value[2])
  })
}
```

##More on `observe({})`  

  - Can read reactive values and call reactive expressions    
  
>  - *Automatically* re-execute when dependencies change    

>  - Doesn't yield a result

>  - Mostly used to update UI elements (more later)   
  
```{r correct-reactivity,echo=TRUE,eval=FALSE}
shinyServer(function(input,output){
  #would now print to console
  observe({print(input$NI+10)})

	#update UI
	observe({
		input$noPitch
		updateCheckboxGroupInput(session, "pitchTypeChoice", selected = c(""))
	})
}
```  


##Summary So Far   
`ui.r`    

  - Controls layout of app    
  - Basic layout uses a sidebar panel and a main panel    
  - Use strings, formatted (html style) text, widgets (`input*` functions), and output from `server.r`  (`*Output` functions)    
  - Separate items with commas      
  
`server.r`    

  - Back-end for app      
  - Create outputs that react to inputs (`render*` functions)      
  - To respond to input, must be in a reactive context      


## Devloping an App

- **Highly Recommended:** 

Draw out what you want the app to look like    

- Write R code to complete your app in a static manner! 

- Translate to appropriate Shiny output functions



## Activity 

- [**First Full App Activity** instructions](http://www4.stat.ncsu.edu/~post/IntermediateR/FirstAppActivity.html) available on web  

- Work in small groups  

- Ask questions!  TAs and I will float about the room  

- Feel free to ask questions about anything you didn't understand as well!   


## What do we want to be able to do?

- Communicate findings effectively 

- Document findings 

- Make process reproducible  

- Share process


##Dynamic UI  
  
  - Often want to update UI based on user input!  
  
 > - Recall:  UI and Server basically pass lists back and forth

 > - Methods for updating UI  
     <ul>  
         <li> `update*` functions</li>  
         <li> `renderUI()`/`uiOutput()`</li>
         <li> `conditionalPanel()`</li>  
      </ul>  
      
      
##Using update* Functions  

  - Every input widget has a corresponding update function  
    + `updateActionButton()`  
    + `updateCheckboxInput()`  
    + `updateNumericInput()`  
    + ...
 
##Using update* Functions  

  - Every input widget has a corresponding update function  
    + `updateActionButton()`  
    + `updateCheckboxInput()`  
    + `updateNumericInput()`  
    + ...
    
  - Require session argument on server() function  
```{r session,echo=TRUE,eval=FALSE}
shinyServer(function(input, output,session) {
  ## do stuff
})
```  

##Using update* Functions  

  - Every input widget has a corresponding update function  
    + `updateActionButton()`  
    + `updateCheckboxInput()`  
    + `updateNumericInput()`  
    + ...
    
  - Require session argument on server() function  
```{r session2,echo=TRUE,eval=FALSE}
shinyServer(function(input, output,session) {
  ## do stuff
})
```  
  - After all observers (reactive things) evaluate, updater sends message back to client



##Using update* Functions

  - Syntax of `update*` functions similar to the functions that created the inputs
  
Example syntax:  

```{r update, echo = TRUE, eval = FALSE}
numericInput(inputId, label, value, min = NA, max = NA, step = NA,
  width = NULL)

updateNumericInput(session, inputId, label = NULL, value = NULL,
  min = NULL, max = NULL, step = NULL)  
```  



##Using update* Functions

  - Syntax of `update*` functions similar to the functions that created the inputs
  
Example syntax:  

```{r update2, echo = TRUE, eval = FALSE}
numericInput(inputId, label, value, min = NA, max = NA, step = NA,
  width = NULL)

updateNumericInput(session, inputId, label = NULL, value = NULL,
  min = NULL, max = NULL, step = NULL)  
```  

  - Any arguments with `NULL` values ignored (i.e. will not result in any changes to the input object)

>  - For `radioButtons()`, `checkboxGroupInput()`, and `selectInput()`, the set of choices can be cleared by using `choices = character(0)` (similary for the set of selected)

##Using `update*` Functions  
```{r update-ftns, eval = TRUE, echo = FALSE}
library(shiny)
shinyApp(
  # Define UI for application that draws a histogram
  ui <- fluidPage(
     # Application title
     titlePanel("Old Faithful Geyser Data"),
     # Sidebar with a slider input for number of bins 
     sidebarLayout(
        sidebarPanel(
           sliderInput("bins",
                       "Number of bins:",
                       min = 1,
                       max = 50,
                       value = 30),
           numericInput("maxBins",label="Set Maximum Number of Bins",value=50,min=1,max=100)
        ),
        # Show a plot of the generated distribution
        mainPanel(
           plotOutput("distPlot")
        )
     )
  ),
  # Define server logic required to draw a histogram
  server <- function(input, output,session) {
     output$distPlot <- renderPlot({
        # generate bins based on input$bins from ui.R
        x    <- faithful[, 2] 
        bins <- seq(min(x), max(x), length.out = input$bins + 1)
        
        # draw the histogram with the specified number of bins
        hist(x, breaks = bins, col = 'darkgray', border = 'white')
     })
     
     observe({updateSliderInput(session,"bins",max=input$maxBins)})
  }
)
```  

##`updateSliderInput()` (First Attempt)
```{r updateslider,eval=FALSE,echo=TRUE}
  ui <- fluidPage(
        ...
        sidebarPanel(
           sliderInput("bins","Number of bins:",min = 1,
                       max = 50,value = 30),
           numericInput("maxBins",label="Set Maximum Number of Bins",
                        value=50,min=1,max=100)
        ),
        ...
  ),
  server <- function(input, output,session) {
      ...
      updateSliderInput(session,"bins",max=input$maxBins)
  }
)
```  
What is our issue?

##`updateSliderInput()` (Fixed)
```{r updateslider2,eval=FALSE,echo=TRUE}
  ui <- fluidPage(
        ...
        sidebarPanel(
           sliderInput("bins","Number of bins:",
                       min = 1,max = 50,value = 30),
           numericInput("maxBins",label="Set Maximum Number of Bins",
                        value=50,min=1,max=100)
        ),
        ...
  )
  server <- function(input, output,session) {
      ...
      observe({updateSliderInput(session,"bins",max=input$maxBins)})
  }
``` 

##`update*` UI Functions  

 - Use the template app  
 
 - Try to add a numeric input for the user to specify the largest value of the slider  
 
 - Use the `updateSliderInput` function to update the max of the slider  
 
 - Don't forget `observe`!
 
 

##`renderUI()` and `uiOutput()`  

  - Alternatively, `renderUI()` and `uiOutput()` can be used  


##`renderUI()` and `uiOutput()`  

  - Alternatively, `renderUI()` and `uiOutput()` can be used  
  - Note: Shiny essentially writes HTML/JavaScript for us!
```{r html,echo=TRUE,eval=TRUE}
print(fluidPage(titlePanel(title="Hi"),
                sidebarLayout(sidebarPanel(),mainPanel())))
```


##`renderUI()` and `uiOutput()`  

  - Alternatively, `renderUI` and `uiOutput` can be used  
  - Note: Shiny essentially writes HTML/JavaScript for us!
```{r html2,echo=TRUE,eval=TRUE}
print(numericInput("id","Label User Sees",value=10))
```

##`renderUI()` and `uiOutput()`  

`renderUI()`    
  
 + Makes a **reactive version** of a function that generates HTML (like any widget)
      
> + Have `renderUI()` return a shiny 'tag object,', HTML, or a list of these    
<br>
<br>
> + Use with `uiOutput()` in UI file     

> + Interprets the HTML and outputs appropriately (a `div` element)  


##`renderUI()` and `uiOutput()` (using widgets)  

```{r renderui-widget,eval=FALSE,echo=TRUE}
  ui <- fluidPage(
        ...
        sidebarPanel(
            uiOutput("slider"),
            numericInput("maxBins",label="Set Maximum Number of Bins",
                         value=50,min=1,max=100)
        ),
        ...
  ),
  server <- function(input, output,session) {
      ...
      output$slider<-renderUI({
          sliderInput("bins","Number of bins:",min = 1,
                      max = input$maxBins,value = 30)
          })
  }
``` 

##`renderUI()` and `uiOutput()` (using HTML)  

```{r renderui-info,eval=FALSE,echo=TRUE}
  ui <- fluidPage(
        ...
        sidebarPanel(
             uiOutput("info"),
             numericInput("purchase",label="How Many?",
                          value=50,min=0,max=100)
        ),
        ...
  ),
  server <- function(input, output,session) {
      ...
        output$info<-renderUI({
          text<-paste0("You have selected to buy ",input$purchase)
          h3(text)
        })
  }
``` 

##`renderUI()` and `uiOutput()` (using HTML) 

```{r renderui-ex,eval=TRUE,echo=FALSE}
library(shiny)

shinyApp(
  # Define UI for application that draws a histogram
  shinyUI(fluidPage(
    
    # Application title
    titlePanel("Graph is Meaningless Here!"),
    
    # Sidebar 
    sidebarLayout(
      sidebarPanel(
         uiOutput("info"),
         numericInput("purchase",label="How Many?",
                      value=50,min=0,max=100)
      ),
      
      # Show a plot of the generated distribution
      mainPanel(
         plotOutput("distPlot")
      )
    )
  )),
  shinyServer(function(input, output,session) {
   
    output$distPlot <- renderPlot({
  
      # draw the histogram with the specified number of bins
      hist(rnorm(100), col = 'darkgray', border = 'white')
      
    })
    
    output$info<-renderUI({
      text<-paste0("You have selected to buy ",input$purchase)
      h3(text)
    })

  })
)
```


##`renderUI()` and `uiOutput()` (using HTML)  

- Use the template app  

- Try to add some dynamic updating text to the UI  


##`conditionalPanel()`  

  - Create a 'panel' that is only visible if a condition is met  

 > - Condition can depend on input or output value   
 
 > - Accessed differently!  (Use a '.' not a '$')  


##`conditionalPanel()`  

```{r cond-panel-ex,echo=FALSE,eval=TRUE,message=FALSE}
library(shiny)
library(ggplot2)
library(dplyr)
data2<-filter(diamonds,(diamonds$depth>55)&(diamonds$depth<70))
shinyApp(
  # Define UI for application that draws a histogram
  shinyUI(fluidPage(
    
    # Application title
    titlePanel("Plots of Diamonds Data"),
    
    # Sidebar with a slider input for number of bins 
    sidebarLayout(
      sidebarPanel(
        selectInput("plotType", "Plot Type",
                    c(Scatter = "scatter",Histogram = "hist")),
        
        # Only show this panel if the plot type is a histogram
        conditionalPanel(condition = "input.plotType == 'hist'",
                         selectInput("breaks", "Breaks",
                                     c("Sturges","Scott","Freedman-Diaconis","[Custom]" = "custom")),
                         
           # Only show this panel if Custom is selected
          conditionalPanel(
            condition = "input.breaks == 'custom'",
            sliderInput("breakCount", "Break Count", min=1, max=200, value=40)
          )
        )
      ),
      
      # Show a plot of the generated distribution
      mainPanel(
         plotOutput("distPlot")
      )
    )
  )),
  # Define server logic required to draw a histogram
  shinyServer(function(input, output,session) {
     
    output$distPlot <- renderPlot({
  
      #depending on plot type create hist or scatterplot
      if(input$plotType=="scatter"){
        plot(x=data2$carat,y=data2$depth,xlab="Carat",ylab="Depth")
      } else {
        if(input$breaks=="custom"){
          hist(data2$depth,breaks=input$breakCount)
        } else {
          hist(data2$depth,breaks=input$breaks,xlab="Depth")
        }
      }
  
    })
    
  })
)
```
  
##`conditionalPanel()`  
```{r cond-panel-syntax,echo=TRUE,eval=FALSE}
...
sidebarPanel(
  selectInput("plotType", "Plot Type",
            c(Scatter = "scatter",Histogram = "hist")),
  
  # Only show this panel if the plot type is a histogram
  conditionalPanel(condition = "input.plotType == 'hist'",
          selectInput("breaks", "Breaks",
               c("Sturges","Scott","Freedman-Diaconis","[Custom]" = "custom")),
                       
      # Secondary conditonalPanel, Only show this panel if Custom is selected
      conditionalPanel(
          condition = "input.breaks == 'custom'",
          sliderInput("breakCount", "Break Count", min=1, max=200, value=40)
      )
  )
)
```

##`conditionalPanel()`  

- Use the template app  

- Try to add a new UI element if a condition of the slider is met  


##Dynamic UI Recap  
  
- Often want to update UI based on user input!  
  
- Recall:  UI and server basically pass lists back and forth  

- Methods for updating UI  
    + `update*` functions  
    + `renderUI()`/`uiOutput()`  
    + `conditionalPanel()`  

 
 

##More Advanced UI Layout  
  - Contents of UI wrapped in `fluidPage()`  
  
> - Content can be wrapped in `fluidRow()`'s  
  
> - Columns can be created   
  
> - Should sum to 12 in total width!
    

##Customized Layout
```{r custom-layout,eval=TRUE,echo=FALSE}
shinyUI(fluidPage(
  fluidRow(
    column(2,"fluidRow with columns-----------------------------------------------------------------------"),
    column(6,"2nd column------------------------------------------------------------------------------------------------------------------------"),
    column(4,"column widths in a given row should add to 12-------------------------------------------------------------")),
  fluidRow(tags$hr()),
  fluidRow(
    column(6,"2nd fluidRow below above row--------------------------------------------------------------------------------------------"),
    column(6,
           fluidRow("Columns can contain their own fluidRow as well, allowing for a lot of customization of layouts!"),
           fluidRow(
             column(3,"subcol --------------------------------------------"),
             column(9,"subcol ----------------------------------------------------------------------------------------------------------------")
           ))
  )
))
```  


***  
```{r custom-layout2,eval=FALSE,echo=TRUE}
shinyUI(fluidPage(
  fluidRow(
    column(2,"fluidRow with columns--------...---------"),
    column(6,"2nd column------------...--------"),
    column(4,"column widths in a given row must add to 12------...---------")),
  fluidRow(tags$hr()),
  fluidRow(
    column(6,"2nd fluidRow below above row----...-----"),
    column(6,
           fluidRow("Columns can contain their own fluidRow as well, allowing for a lot of customization of layouts!"),
           fluidRow(
             column(3,"subcol ----...-----"),
             column(9,"subcol ----...-----")
           ))
  )
))
```
	




##Recap  
`ui.r`   

  - Controls layout of app (can use standard layouts or customize)  
  - Use strings, formatted (html style) text, widgets (`input*` functions), and output from `server.r`  (`*Output` functions)  
  - Separate items with commas  
  - Update inputs, render HTML reactively, conditionally show input  
  
`server.r`  

  - Back-end for app  
  - Create outputs that react to inputs (`render*` functions)  
  - To respond to input, must be in a reactive context  
  - Code can be included prior to `shinyServer()`  
  

## Activity 

- [**Dynamic UI App Activity** instructions](http://www4.stat.ncsu.edu/~post/IntermediateR/DynamicUIActivity.html) available on web  

- Work in small groups  

- Ask questions!  TAs and I will float about the room  

- Feel free to ask questions about anything you didn't understand as well!  


##Sharing App  
  - Running App locally ties up your system  
  - Others can't access it!  
  - Can host apps on shinyapps.io (powered by RStudio)  
    + Free, but number of connects and hours limited  
    + Gives stats about usage  
    + Integrated into R Studio  

![](img/publish.PNG)     


##Sharing App  

Another option:  

- Host App on Shiny Server  

- Costs money!   
    + Free for academic use (I believe)   

- Might need IT help to utilize  


## What do we want to be able to do?

- Communicate findings effectively 

- Document findings 

- Make process reproducible  

- Share process


## Where do we start?  

- Review of Key Concepts  

- R Markdown Basics  
    + Code Chunks
    + Images/Equations/Misc.

- R Markdown Options
    + Documents: PDF, HTML 
    + Presentations: Slides
    + Interactive Components

- R Shiny Applications/Presentations





##Time Permitting: Miscellaneous Useful Things

Code can be placed prior to shinyServer

```{r common-code,eval=FALSE,echo=TRUE}
##Code here that you only need to evaluate once.
##This can include reading in data, creation of 
##     functions common to all sessions, and 
##     reading of other common r scripts. 

shinyServer(function(input, output) {
  
##Code here that can be reactive.  Differs for 
##     every instance of your app that runs.

})
```

##Other Useful Things  
**Including Other Files**  
```{r include-files, eval=F,echo=TRUE}
## top of server.R, output from here is common to all users

#data set only read in once
dat <- read_csv("dataset.csv")

#function created and not modified
helper <- function(item1, item2) {item1 + item2}

shinyServer(function(input, output) {
  ##reactive things, instance of app dependent
})
```


##Other Useful Things  
**Including Other Files**  

If you have a lot of code, you can read in a separate script   


##Other Useful Things  
**Including Other Files**  

If you have a lot of code, you can read in a separate script   

 - If external script is `helpers.R` in same folder as app:  
 
```{r source, eval=F,echo=TRUE}
## top of server.R
source("helpers.R")

shinyServer(function(input, output) {
  ## do stuff
})
```  


##Other Useful Things  
  - Return `NULL` to remove errors when loading things   
  
  - Can use `isolate()` to improve code efficiency  
```{r isolate,echo=TRUE,eval=FALSE}
observe({
  input$saveButton  # Do take a dependency on input$saveButton

  # isolate a whole block
  data <- isolate({
    a <- input$valueA   # No dependency on input$valueA or input$valueB
    b <- input$valueB
    c(a=a, b=b)
  })
  writeToDatabase(data)
})
```

##Other Useful Things  
  - Improved data tables with `DT` package!  
  - [DT example](http://shiny.stat.ncsu.edu/jbpost2/NBAShotChart/)  
&nbsp;  &nbsp;    

&nbsp;  &nbsp;  

  - Improved plots with `plotly` package!  
  - [plotly example](http://shiny.stat.ncsu.edu/jbpost2/RegVis/)  
  
##Other Useful Things    
  - Can add in Latex easily!  
  
>  - Include `withMathJax()` as a UI argument   

>  - Calls in javascript that will replace Latex source code  

>  - Must open in browser to render!   
  
```{r withMathJax,echo=TRUE,eval=FALSE}
fluidRow(
    #add in latex functionality if needed
    withMathJax(),
          ...
```

##Other Useful Things
  - Can add tabs to your apps!  
  - Create "dashboards" with `shinydashboard` package  
  - [Tab and Dashboard example](http://shiny.stat.ncsu.edu/jbpost2/OrderStatsDist/)  
  
&nbsp;  &nbsp;    
 
>  - Use mouse over and click inputs!  
>  - [Click Input Example](http://shiny.stat.ncsu.edu/jbpost2/BasketballCharting)

&nbsp;  &nbsp;  

> - Include Shiny in your Markdown slides!  
> - Use ioslides and add `runtime: shiny`

  
##Other Useful Things  

  - [shinythemes](https://rstudio.github.io/shinythemes/) are available  
  - [shinyjs package](https://github.com/daattali/shinyjs) adds more functionality  
  - Can [grab apps from GitHub](https://github.com/rstudio/shiny_example)
  - List of [all functions](https://shiny.rstudio.com/reference/shiny/latest/) for the UI and server  
  - Lots of good tutorials!  
    + [Shiny tutorials](https://shiny.rstudio.com/tutorial/)
    + [Dean Attali](http://deanattali.com/blog/building-shiny-apps-tutorial/)
    + [Shiny Articles](http://shiny.rstudio.com/articles/)
  - [R Shiny Cheat Sheet](http://shiny.rstudio.com/images/shiny-cheatsheet.pdf)


##Debugging
  - Much harder in shiny!  
  - Recommendation: Get static working code, then transfer to shiny  


##Debugging

  - Can use `observe({print(...)})`  

```{r,echo=TRUE,eval=FALSE}
shinyServer(function(input,output){

  #would now print to console
  observe({print(input$NI+10)})

}
```  

##Debugging  

[R studio gives](http://shiny.rstudio.com/articles/debugging.html) three major approaches:  

  1. Breakpoints - Pausing execution of your program

  2. Tracing - Collecting information as your program runs

  3. Error handling - Finding the source of errors (both on the client and server side) and ascertaining their cause.  
  
##Breakpoints  
  - Can be used in `server.r`  
  - Click to the left of the line number  
  ![](img/breakpointExample.PNG)  

 > - Now can access values and step through program  

 > - Can also use browser()
  
##Tracing  
  - Can run apps in ['showcase mode'](http://shiny.rstudio.com/gallery/kmeans-example.html)      
  - Invoke your app with the code below  
  
```{r,echo=TRUE,eval=FALSE}
shiny::runApp(display.mode="showcase")
```

  - Also a reactive log that can be viewed  
  
##Error Handling  
  - Check stack trace shiny returns

![](img/stacktrace.PNG)  

##Enter Debug Mode on Error  
  - Can make Shiny enter the debugger when an error occurs by using the following statement:  

```{r,echo=TRUE,eval=FALSE}
options(shiny.error = browser)
```  

  - Overall, experience helps!    
  
